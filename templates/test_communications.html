{% extends "base.html" %}

{% block title %}Communication Testing - CoastalGuard AI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-satellite-dish text-blue-600 mr-3"></i>
                Communication Testing Center
            </h1>
            <p class="text-gray-600">Test email and SMS notification systems for CoastalGuard AI</p>
        </div>

        <!-- Testing Forms -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Email Testing -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-envelope text-blue-600 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold text-gray-900">Email Test</h2>
                </div>
                
                <form id="email-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email-recipient" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="test@example.com" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Custom Message (Optional)
                        </label>
                        <textarea id="email-message" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  rows="3" placeholder="Leave empty for default test message"></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send Test Email
                    </button>
                </form>
                
                <div id="email-result" class="mt-4 hidden"></div>
            </div>

            <!-- SMS Testing -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-sms text-green-600 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold text-gray-900">SMS Test</h2>
                </div>
                
                <form id="sms-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="sms-recipient" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="+919999999999" required>
                        <p class="text-xs text-gray-500 mt-1">Include country code (+91 for India)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Custom Message (Optional, max 160 chars)
                        </label>
                        <textarea id="sms-message" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                  rows="3" maxlength="160" placeholder="Leave empty for default test message"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Character count: <span id="sms-char-count">0</span>/160</p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-mobile-alt mr-2"></i>
                        Send Test SMS
                    </button>
                </form>
                
                <div id="sms-result" class="mt-4 hidden"></div>
            </div>
        </div>

        <!-- Configuration Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-cog text-gray-600 mr-2"></i>
                Configuration Status
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                    <span class="text-sm text-gray-700">Email: SMTP Configured</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                    <span class="text-sm text-gray-700">SMS: Twilio Configured</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center">
            <a href="/dashboard" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counter for SMS
    const smsMessage = document.getElementById('sms-message');
    const charCount = document.getElementById('sms-char-count');
    
    smsMessage.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });
    
    // Form submission handlers
    const forms = [
        { id: 'email-form', type: 'email', recipientId: 'email-recipient', messageId: 'email-message', resultId: 'email-result' },
        { id: 'sms-form', type: 'sms', recipientId: 'sms-recipient', messageId: 'sms-message', resultId: 'sms-result' }
    ];
    
    forms.forEach(form => {
        document.getElementById(form.id).addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recipient = document.getElementById(form.recipientId).value;
            const message = document.getElementById(form.messageId).value;
            const resultDiv = document.getElementById(form.resultId);
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            
            resultDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Sending test message...</div>';
            resultDiv.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/test-communications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: form.type,
                        recipient: recipient,
                        message: message
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-md p-3">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="text-green-800 font-medium">Success!</span>
                            </div>
                            <p class="text-green-700 text-sm mt-1">${data.message}</p>
                            <p class="text-green-600 text-xs mt-1">Sent at: ${data.timestamp}</p>
                            ${data.sid ? `<p class="text-green-600 text-xs">Message ID: ${data.sid}</p>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-3">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                <span class="text-red-800 font-medium">Failed!</span>
                            </div>
                            <p class="text-red-700 text-sm mt-1">${data.error}</p>
                            <p class="text-red-600 text-xs mt-1">Time: ${data.timestamp || new Date().toLocaleString()}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-md p-3">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <span class="text-red-800 font-medium">Network Error!</span>
                        </div>
                        <p class="text-red-700 text-sm mt-1">${error.message}</p>
                    </div>
                `;
            } finally {
                // Reset button
                submitBtn.disabled = false;
                const icons = {
                    'email': 'fa-paper-plane',
                    'sms': 'fa-mobile-alt'
                };
                const labels = {
                    'email': 'Send Test Email',
                    'sms': 'Send Test SMS'
                };
                submitBtn.innerHTML = `<i class="fas ${icons[form.type]} mr-2"></i>${labels[form.type]}`;
            }
        });
    });
});
</script>
{% endblock %}
