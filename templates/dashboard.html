{% extends "base.html" %}

{% block title %}CoastalGuard AI Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-full mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">CoastalGuard AI Dashboard</h1>
                <p class="text-gray-600 mt-1">Advanced coastal threat monitoring for Gujarat with detailed analytics</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Overall Status Indicator -->
                <div class="flex items-center bg-green-50 px-4 py-2 rounded-lg">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    <span class="text-green-800 font-medium">All Systems Active</span>
                </div>
                <!-- Sidebar Toggle -->
                <button id="sidebar-toggle" class="bg-ocean-blue text-white px-4 py-2 rounded-lg hover:bg-ocean-dark transition-colors">
                    <i class="fas fa-bars mr-2"></i>City Details
                </button>
                <!-- Last Updated -->
                <div class="text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    Last updated: <span id="last-updated">2 minutes ago</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Layout with Sidebar -->
<div class="flex max-w-full mx-auto">
    <!-- City Details Sidebar -->
    <div id="city-sidebar" class="w-80 bg-white shadow-lg border-r border-gray-200 min-h-screen transition-all duration-300">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-map-marker-alt text-ocean-blue mr-2"></i>
                Gujarat Cities
            </h2>
            
            <!-- City List -->
            <div class="space-y-2">
                {% if all_cities_data %}
                    {% for city, data in all_cities_data.items() %}
                        <div class="city-item cursor-pointer p-3 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all" 
                             data-city="{{ city }}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas {{ data.icon }} text-ocean-blue mr-3"></i>
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ city }}</h4>
                                        <p class="text-sm text-gray-600">{{ data.temperature }}¬∞C ‚Ä¢ {{ data.description }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 
                                        {% if data.threat_level == 'green' %}bg-green-500{% elif data.threat_level == 'yellow' %}bg-yellow-500{% else %}bg-red-500{% endif %} 
                                        rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- Fallback city list -->
                    <div class="space-y-2">
                        <div class="city-item cursor-pointer p-3 rounded-lg border border-gray-200 hover:bg-blue-50" data-city="Ahmedabad">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-anchor text-ocean-blue mr-3"></i>
                                    <div>
                                        <h4 class="font-medium">Ahmedabad</h4>
                                        <p class="text-sm text-gray-600">28¬∞C ‚Ä¢ Clear Sky</p>
                                    </div>
                                </div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="city-item cursor-pointer p-3 rounded-lg border border-gray-200 hover:bg-blue-50" data-city="Surat">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-ship text-ocean-blue mr-3"></i>
                                    <div>
                                        <h4 class="font-medium">Surat</h4>
                                        <p class="text-sm text-gray-600">26¬∞C ‚Ä¢ Partly Cloudy</p>
                                    </div>
                                </div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="city-item cursor-pointer p-3 rounded-lg border border-gray-200 hover:bg-blue-50" data-city="Dwarka">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-water text-ocean-blue mr-3"></i>
                                    <div>
                                        <h4 class="font-medium">Dwarka</h4>
                                        <p class="text-sm text-gray-600">25¬∞C ‚Ä¢ Windy</p>
                                    </div>
                                </div>
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Detailed City Info Panel -->
        <div id="city-details" class="p-6">
            <div class="text-center text-gray-500">
                <i class="fas fa-mouse-pointer text-3xl mb-3"></i>
                <p>Click on a city above to view detailed weather information</p>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 px-4 py-8">
        {% if error %}
            <!-- Error Message -->
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-8">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            Error loading dashboard data: {{ error }}. Using fallback data.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Enhanced Alert Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Alerts -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-bell text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Alerts</p>
                        <p class="text-2xl font-bold text-gray-900">{{ total_alerts if total_alerts else 24 }}</p>
                        <p class="text-xs text-gray-500">Last 24 hours</p>
                    </div>
                </div>
            </div>
            
            <!-- Critical Alerts -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Critical</p>
                        <p class="text-2xl font-bold text-red-600">{{ critical_alerts if critical_alerts else 0 }}</p>
                        <p class="text-xs text-gray-500">Requires action</p>
                    </div>
                </div>
            </div>
            
            <!-- Monitored Cities -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-map-marker-alt text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Cities</p>
                        <p class="text-2xl font-bold text-gray-900">{{ city_stats.total if city_stats else 10 }}</p>
                        <p class="text-xs text-gray-500">Active monitoring</p>
                    </div>
                </div>
            </div>
            
            <!-- Community Reports -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-users text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Reports</p>
                        <p class="text-2xl font-bold text-gray-900">{{ total_reports if total_reports else 7 }}</p>
                        <p class="text-xs text-gray-500">Community input</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Weather Overview Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Current Weather Highlights -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-cloud-sun text-blue-500 mr-2"></i>
                        Weather Highlights
                    </h2>
                    <div class="text-sm text-gray-500">Real-time data</div>
                </div>
                
                <!-- Weather Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if weather_data %}
                        {% for city, data in weather_data.items() %}
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-900">{{ city }}</h3>
                                    <i class="fas {{ data.icon }} text-blue-600 text-xl"></i>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <p class="text-gray-600">Temperature</p>
                                        <p class="font-bold text-lg">{{ data.temperature }}¬∞C</p>
                                        <p class="text-xs text-gray-500">Feels like {{ data.feels_like }}¬∞C</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Humidity</p>
                                        <p class="font-bold text-lg">{{ data.humidity }}%</p>
                                        <p class="text-xs text-gray-500">{{ data.description|title }}</p>
                                    </div>
                                    
                                    {% if data.wind_speed %}
                                    <div>
                                        <p class="text-gray-600">Wind</p>
                                        <p class="font-bold">{{ data.wind_speed }} km/h</p>
                                        <p class="text-xs text-gray-500">{{ data.wind_direction }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if data.sea_conditions %}
                                    <div>
                                        <p class="text-gray-600">Sea Conditions</p>
                                        <p class="font-bold">{{ data.sea_conditions }}</p>
                                        <p class="text-xs text-gray-500">{{ data.wave_height }}m waves</p>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Additional Weather Metrics -->
                                {% if data.pressure or data.uv_index %}
                                <div class="mt-3 pt-3 border-t border-blue-200">
                                    <div class="flex justify-between text-xs">
                                        {% if data.pressure %}
                                        <span class="text-gray-600">Pressure: <strong>{{ data.pressure }} hPa</strong></span>
                                        {% endif %}
                                        {% if data.uv_index %}
                                        <span class="text-gray-600">UV Index: <strong>{{ data.uv_index }}</strong></span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback weather cards -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-900">Ahmedabad</h3>
                                <i class="fas fa-sun text-yellow-500 text-xl"></i>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <p class="text-gray-600">Temperature</p>
                                    <p class="font-bold text-lg">28¬∞C</p>
                                    <p class="text-xs text-gray-500">Feels like 31¬∞C</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Humidity</p>
                                    <p class="font-bold text-lg">65%</p>
                                    <p class="text-xs text-gray-500">Clear Sky</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-900">Surat</h3>
                                <i class="fas fa-cloud text-gray-500 text-xl"></i>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <p class="text-gray-600">Temperature</p>
                                    <p class="font-bold text-lg">26¬∞C</p>
                                    <p class="text-xs text-gray-500">Feels like 29¬∞C</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Humidity</p>
                                    <p class="font-bold text-lg">72%</p>
                                    <p class="text-xs text-gray-500">Partly Cloudy</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- AI Alert Analysis -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-brain text-purple-500 mr-2"></i>
                        AI Alert Analysis
                    </h2>
                    <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        Powered by Gemini AI
                    </div>
                </div>
                
                <!-- Alert Cards -->
                <div class="space-y-4 ai-alerts-container">
                    {% if ai_alerts %}
                        {% for alert in ai_alerts %}
                            <div class="ai-alert-card border border-gray-200 rounded-lg p-4 
                                {% if alert.level == 'red' %}bg-red-50 border-red-200{% elif alert.level == 'yellow' %}bg-yellow-50 border-yellow-200{% elif alert.level == 'loading' %}bg-blue-50 border-blue-200{% else %}bg-green-50 border-green-200{% endif %}">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start">
                                        <div class="p-2 rounded-lg mr-3
                                            {% if alert.level == 'red' %}bg-red-100{% elif alert.level == 'yellow' %}bg-yellow-100{% elif alert.level == 'loading' %}bg-blue-100{% else %}bg-green-100{% endif %}">
                                            <i class="alert-icon fas {{ alert.icon }} 
                                                {% if alert.level == 'red' %}text-red-600{% elif alert.level == 'yellow' %}text-yellow-600{% elif alert.level == 'loading' %}text-blue-600{% else %}text-green-600{% endif %}"></i>
                                        </div>
                                        <div>
                                            <h4 class="alert-title font-semibold text-gray-900">{{ alert.title }}</h4>
                                            <p class="alert-description text-sm text-gray-700 mt-1">{{ alert.description }}</p>
                                            <div class="flex items-center mt-2 text-xs text-gray-500">
                                                <i class="fas fa-map-marker-alt mr-1"></i>
                                                <span class="alert-location">{{ alert.location }}</span>
                                                <span class="mx-2">‚Ä¢</span>
                                                <i class="fas fa-clock mr-1"></i>
                                                <span class="alert-time">{{ alert.time }}</span>
                                            </div>
                                            {% if alert.recommended_action %}
                                            <div class="mt-2 text-xs text-gray-600">
                                                <i class="fas fa-lightbulb mr-1"></i>
                                                <span class="recommended-action">{{ alert.recommended_action }}</span>
                                            </div>
                                            {% endif %}
                                            {% if alert.threat_score and alert.threat_score > 0 %}
                                            <div class="mt-1 text-xs text-gray-600">
                                                <span class="threat-score">Threat Score: {{ alert.threat_score }}/10</span>
                                            </div>
                                            {% endif %}
                                            {% if alert.data_source %}
                                            <div class="mt-1 text-xs text-gray-500">
                                                <span class="data-source">{{ alert.data_source }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium
                                            {% if alert.level == 'red' %}bg-red-100 text-red-800{% elif alert.level == 'yellow' %}bg-yellow-100 text-yellow-800{% elif alert.level == 'loading' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                                            {% if alert.level == 'loading' %}ANALYZING{% else %}{{ alert.level|upper }}{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback alerts -->
                        <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                            <div class="flex items-start">
                                <div class="p-2 bg-green-100 rounded-lg mr-3">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">All Clear</h4>
                                    <p class="text-sm text-gray-700 mt-1">No immediate threats detected. All coastal monitoring systems are functioning normally.</p>
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>Gujarat Coast</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>5 minutes ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Two Column Grid Layout for Map and Community Reports -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Interactive Map Section -->
            <div class="bg-white rounded-lg shadow-lg">
                <!-- Map Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-map text-ocean-blue mr-2"></i>
                        Gujarat Coastal Map
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">Real-time threat levels across coastal cities</p>
                </div>
                
                <!-- Map Container -->
                <div class="p-6">
                    <div class="relative bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg h-96 border-2 border-dashed border-gray-300 overflow-hidden">
                        <!-- Map Background -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-100 to-cyan-100 opacity-30"></div>
                        
                        <!-- City Markers -->
                        {% if all_cities_data %}
                            {% for city, data in all_cities_data.items() %}
                                <div class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer city-marker" 
                                     data-city="{{ city }}"
                                     style="top: {{ loop.index * 15 + 10 }}%; left: {{ loop.index * 12 + 15 }}%;">
                                    <div class="relative group">
                                        <!-- Marker -->
                                        <div class="w-4 h-4 rounded-full border-2 border-white shadow-lg 
                                            {% if data.threat_level == 'green' %}bg-green-500{% elif data.threat_level == 'yellow' %}bg-yellow-500{% else %}bg-red-500{% endif %} 
                                            animate-pulse"></div>
                                        
                                        <!-- City Label -->
                                        <div class="absolute top-5 left-1/2 transform -translate-x-1/2 
                                                    opacity-0 group-hover:opacity-100 transition-opacity duration-200
                                                    bg-white px-2 py-1 rounded shadow-lg text-xs font-medium whitespace-nowrap z-10">
                                            {{ city }}: {{ data.temperature }}¬∞C
                                        </div>
                                        
                                        <!-- Ripple Effect -->
                                        <div class="absolute inset-0 rounded-full border-2 
                                            {% if data.threat_level == 'green' %}border-green-400{% elif data.threat_level == 'yellow' %}border-yellow-400{% else %}border-red-400{% endif %} 
                                            animate-ping opacity-75"></div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Map Placeholder Center -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-map-marked-alt text-gray-400 text-4xl mb-2"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-1">Gujarat Coastal Region</h3>
                                <p class="text-gray-500 text-sm">Interactive threat monitoring map</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Community Reports -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-users text-green-500 mr-2"></i>
                        Community Reports
                    </h2>
                    <a href="{{ url_for('community') }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View All ‚Üí
                    </a>
                </div>
                
                <!-- Report Items -->
                <div class="space-y-4">
                    {% if community_reports %}
                        {% for report in community_reports %}
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start">
                                        <div class="p-2 bg-blue-100 rounded-lg mr-3">
                                            <i class="fas {{ report.icon }} text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900">{{ report.title }}</h4>
                                            <p class="text-sm text-gray-700 mt-1">{{ report.description }}</p>
                                            <div class="flex items-center mt-2 text-xs text-gray-500">
                                                <i class="fas fa-user mr-1"></i>
                                                <span>{{ report.reporter }}</span>
                                                <span class="mx-2">‚Ä¢</span>
                                                <i class="fas fa-map-marker-alt mr-1"></i>
                                                <span>{{ report.location }}</span>
                                                <span class="mx-2">‚Ä¢</span>
                                                <span>{{ report.time }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium
                                            {% if report.status == 'verified' %}bg-green-100 text-green-800{% elif report.status == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ report.status|upper }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback community reports -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="p-2 bg-blue-100 rounded-lg mr-3">
                                    <i class="fas fa-waves text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">High Tide Warning</h4>
                                    <p class="text-sm text-gray-700 mt-1">Unusually high tide observed near Dwarka beach area. Visitors advised to maintain safe distance.</p>
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        <i class="fas fa-user mr-1"></i>
                                        <span>Local Fisherman</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>Dwarka</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <span>1 hour ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="p-2 bg-green-100 rounded-lg mr-3">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">Safe Swimming Conditions</h4>
                                    <p class="text-sm text-gray-700 mt-1">Clear water and calm conditions reported at Mandvi beach. Perfect for recreational activities.</p>
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        <i class="fas fa-user mr-1"></i>
                                        <span>Beach Guard</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>Mandvi</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <span>30 minutes ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Marine Conditions Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-anchor text-blue-500 mr-2"></i>
                    Marine Conditions
                </h2>
                <div class="text-sm text-gray-500">Arabian Sea</div>
            </div>
            
            <!-- Marine Data Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <i class="fas fa-water text-blue-600 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-900">Wave Height</h4>
                    <p class="text-2xl font-bold text-blue-600">1.2m</p>
                    <p class="text-xs text-gray-600">Moderate waves</p>
                </div>
                
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <i class="fas fa-thermometer-half text-green-600 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-900">Sea Temp</h4>
                    <p class="text-2xl font-bold text-green-600">24¬∞C</p>
                    <p class="text-xs text-gray-600">Optimal</p>
                </div>
                
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <i class="fas fa-eye text-yellow-600 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-900">Visibility</h4>
                    <p class="text-2xl font-bold text-yellow-600">8km</p>
                    <p class="text-xs text-gray-600">Good</p>
                </div>
                
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <i class="fas fa-compress-arrows-alt text-purple-600 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-900">Tide Level</h4>
                    <p class="text-2xl font-bold text-purple-600">High</p>
                    <p class="text-xs text-gray-600">Rising</p>
                </div>
            </div>
            
            <!-- Additional Marine Info -->
            <div class="border-t border-gray-200 pt-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <p class="text-gray-600">Sunrise</p>
                        <p class="font-semibold">6:42 AM</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Sunset</p>
                        <p class="font-semibold">6:15 PM</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Moon Phase</p>
                        <p class="font-semibold">üåì First Quarter</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Fishing</p>
                        <p class="font-semibold text-green-600">Favorable</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Sidebar and Interactive Features -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle functionality
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const citySidebar = document.getElementById('city-sidebar');
    const cityItems = document.querySelectorAll('.city-item');
    const cityDetails = document.getElementById('city-details');
    
    if (sidebarToggle && citySidebar) {
        sidebarToggle.addEventListener('click', function() {
            citySidebar.classList.toggle('hidden');
            
            // Update button text
            const isHidden = citySidebar.classList.contains('hidden');
            sidebarToggle.innerHTML = isHidden ? 
                '<i class="fas fa-bars mr-2"></i>Show Cities' : 
                '<i class="fas fa-times mr-2"></i>Hide Cities';
        });
    }
    
    // City item click handlers
    cityItems.forEach(item => {
        item.addEventListener('click', function() {
            const cityName = this.dataset.city;
            
            // Remove active class from all items
            cityItems.forEach(i => i.classList.remove('bg-blue-100', 'border-blue-300'));
            
            // Add active class to clicked item
            this.classList.add('bg-blue-100', 'border-blue-300');
            
            // Load detailed city information
            loadCityDetails(cityName);
        });
    });
    
    // Map marker click handlers
    const mapMarkers = document.querySelectorAll('.city-marker');
    mapMarkers.forEach(marker => {
        marker.addEventListener('click', function() {
            const cityName = this.dataset.city;
            
            // Highlight corresponding city in sidebar
            cityItems.forEach(item => {
                if (item.dataset.city === cityName) {
                    item.classList.add('bg-blue-100', 'border-blue-300');
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.classList.remove('bg-blue-100', 'border-blue-300');
                }
            });
            
            // Load detailed city information
            loadCityDetails(cityName);
        });
    });
    
    // Function to load city details
    function loadCityDetails(cityName) {
        // Show loading state
        cityDetails.innerHTML = `
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-ocean-blue mx-auto mb-3"></div>
                <p class="text-gray-600">Loading ${cityName} details...</p>
            </div>
        `;
        
        // Fetch city details from API
        fetch(`/api/city/${cityName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                const detailsHTML = generateCityDetailsHTML(data);
                cityDetails.innerHTML = detailsHTML;
            })
            .catch(error => {
                console.error('Error fetching city details:', error);
                // Fallback to mock data
                const mockData = generateMockCityData(cityName);
                const detailsHTML = generateCityDetailsHTML(mockData);
                cityDetails.innerHTML = detailsHTML;
            });
    }
    
    // Function to generate mock city data
    function generateMockCityData(cityName) {
        return {
            city: cityName,
            temperature: Math.floor(Math.random() * 15) + 20,
            feels_like: Math.floor(Math.random() * 15) + 22,
            humidity: Math.floor(Math.random() * 40) + 50,
            wind_speed: Math.floor(Math.random() * 20) + 5,
            pressure: Math.floor(Math.random() * 50) + 1000,
            visibility: Math.floor(Math.random() * 5) + 5,
            uv_index: Math.floor(Math.random() * 10) + 1,
            air_quality: ['Good', 'Moderate', 'Unhealthy'][Math.floor(Math.random() * 3)],
            description: ['Clear Sky', 'Partly Cloudy', 'Cloudy'][Math.floor(Math.random() * 3)]
        };
    }
    
    // Function to generate city details HTML
    function generateCityDetailsHTML(data) {
        return `
            <div class="space-y-4">
                <div class="border-b border-gray-200 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        <i class="fas fa-map-marker-alt text-ocean-blue mr-2"></i>
                        ${data.city} Details
                    </h3>
                    <p class="text-sm text-gray-600">Detailed weather and marine conditions</p>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Temperature</span>
                            <span class="text-lg font-bold text-blue-600">${data.temperature}¬∞C</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${(data.temperature / 40) * 100}%"></div>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Feels like ${data.feels_like}¬∞C</p>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Humidity</span>
                            <span class="text-lg font-bold text-green-600">${data.humidity}%</span>
                        </div>
                        <div class="w-full bg-green-200 rounded-full h-2 mt-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: ${data.humidity}%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Wind Speed</span>
                            <span class="text-lg font-bold text-yellow-600">${data.wind_speed} km/h</span>
                        </div>
                        <div class="w-full bg-yellow-200 rounded-full h-2 mt-2">
                            <div class="bg-yellow-600 h-2 rounded-full" style="width: ${(data.wind_speed / 25) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Pressure</span>
                            <span class="text-lg font-bold text-purple-600">${data.pressure} hPa</span>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Visibility</span>
                            <span class="text-lg font-bold text-indigo-600">${data.visibility} km</span>
                        </div>
                    </div>
                    
                    ${data.uv_index ? `
                    <div class="bg-orange-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">UV Index</span>
                            <span class="text-lg font-bold text-orange-600">${data.uv_index}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${data.air_quality ? `
                    <div class="bg-teal-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Air Quality</span>
                            <span class="text-lg font-bold text-teal-600">${data.air_quality}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="font-medium text-gray-900 mb-3">48-Hour Forecast</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Tomorrow</span>
                            <div class="flex items-center">
                                <i class="fas fa-sun text-yellow-500 mr-2"></i>
                                <span class="font-medium">${data.temperature + 2}¬∞C / ${data.temperature - 3}¬∞C</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Day After</span>
                            <div class="flex items-center">
                                <i class="fas fa-cloud text-gray-500 mr-2"></i>
                                <span class="font-medium">${data.temperature + 1}¬∞C / ${data.temperature - 2}¬∞C</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-100 rounded-lg p-3 mt-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <span class="text-sm text-blue-800 font-medium">Marine Safety</span>
                    </div>
                    <p class="text-xs text-blue-700 mt-1">Conditions are favorable for coastal activities. Monitor updates for any changes.</p>
                </div>
            </div>
        `;
    }
    
    // Auto-refresh functionality
    function updateTimestamp() {
        const timestamp = document.getElementById('last-updated');
        if (timestamp) {
            const now = new Date();
            const minutes = Math.floor(Math.random() * 5) + 1;
            timestamp.textContent = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        }
    }
    
    // Update timestamp every 30 seconds
    setInterval(updateTimestamp, 30000);
    
    // Initial timestamp update
    updateTimestamp();
    
    // ASYNC AI ANALYSIS LOADING
    function loadAIAnalysis() {
        console.log('üöÄ DEBUG: Starting async AI analysis loading...');
        console.log('üì° DEBUG: Making AJAX request to /api/ai-analysis');
        
        // Make AJAX request to get AI analysis
        fetch('/api/ai-analysis')
            .then(response => {
                console.log('üì° DEBUG: Received response from AI analysis API');
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ DEBUG: AI Analysis data received:', data);
                console.log('üîÑ DEBUG: Updating dashboard with real AI data...');
                updateAIAlertsDisplay(data);
            })
            .catch(error => {
                console.error('‚ùå DEBUG: Error loading AI analysis:', error);
                showAIErrorState(error);
            });
    }
    
    function updateAIAlertsDisplay(data) {
        console.log('üîÑ DEBUG: Updating AI alerts display with received data');
        const aiAlertsContainer = document.querySelector('.ai-alerts-container');
        if (!aiAlertsContainer) {
            console.warn('‚ö†Ô∏è DEBUG: AI alerts container not found in DOM');
            return;
        }
        
        if (data.success && data.ai_alert) {
            const alert = data.ai_alert;
            console.log('‚úÖ DEBUG: Successfully processing AI alert data:', alert.title);
            
            // Find the AI alert card and update it
            const aiAlertCard = aiAlertsContainer.querySelector('.ai-alert-card');
            if (aiAlertCard) {
                console.log('üéØ DEBUG: Found AI alert card, updating elements...');
                // Update title
                const titleElement = aiAlertCard.querySelector('.alert-title');
                if (titleElement) titleElement.textContent = alert.title;
                
                // Update description
                const descElement = aiAlertCard.querySelector('.alert-description');
                if (descElement) descElement.textContent = alert.description;
                
                // Update location
                const locationElement = aiAlertCard.querySelector('.alert-location');
                if (locationElement) locationElement.textContent = alert.location;
                
                // Update time
                const timeElement = aiAlertCard.querySelector('.alert-time');
                if (timeElement) timeElement.textContent = alert.time;
                
                // Update icon (remove spinner, add brain icon)
                const iconElement = aiAlertCard.querySelector('.alert-icon');
                if (iconElement) {
                    iconElement.className = `fas ${alert.icon} mr-3 text-lg`;
                }
                
                // Update alert level styling
                updateAlertLevelStyling(aiAlertCard, alert.level);
                
                // Update additional data if elements exist
                const actionElement = aiAlertCard.querySelector('.recommended-action');
                if (actionElement) actionElement.textContent = alert.recommended_action;
                
                const scoreElement = aiAlertCard.querySelector('.threat-score');
                if (scoreElement) scoreElement.textContent = `Threat Score: ${alert.threat_score}/10`;
                
                const sourceElement = aiAlertCard.querySelector('.data-source');
                if (sourceElement) sourceElement.textContent = alert.data_source;
                
                console.log('‚úÖ DEBUG: AI alert display updated successfully');
            } else {
                console.warn('‚ö†Ô∏è DEBUG: AI alert card not found in container');
            }
        } else {
            console.warn('‚ö†Ô∏è DEBUG: Invalid AI analysis data received:', data);
        }
    }
    
    function updateAlertLevelStyling(alertCard, level) {
        // Remove existing level classes
        alertCard.classList.remove('border-red-200', 'bg-red-50', 'border-yellow-200', 'bg-yellow-50', 'border-green-200', 'bg-green-50', 'border-blue-200', 'bg-blue-50');
        
        // Add appropriate styling based on alert level
        switch(level) {
            case 'red':
                alertCard.classList.add('border-red-200', 'bg-red-50');
                break;
            case 'yellow':
                alertCard.classList.add('border-yellow-200', 'bg-yellow-50');
                break;
            case 'green':
                alertCard.classList.add('border-green-200', 'bg-green-50');
                break;
            default:
                alertCard.classList.add('border-blue-200', 'bg-blue-50');
        }
    }
    
    function showAIErrorState(error) {
        console.log('‚ùå DEBUG: Showing AI error state due to:', error);
        const aiAlertsContainer = document.querySelector('.ai-alerts-container');
        if (!aiAlertsContainer) return;
        
        const aiAlertCard = aiAlertsContainer.querySelector('.ai-alert-card');
        if (aiAlertCard) {
            // Update to show error state
            const titleElement = aiAlertCard.querySelector('.alert-title');
            if (titleElement) titleElement.textContent = 'AI Analysis - Service Unavailable';
            
            const descElement = aiAlertCard.querySelector('.alert-description');
            if (descElement) descElement.textContent = 'AI analysis temporarily unavailable. Please try refreshing the page.';
            
            const iconElement = aiAlertCard.querySelector('.alert-icon');
            if (iconElement) {
                iconElement.className = 'fas fa-exclamation-triangle mr-3 text-lg text-yellow-600';
            }
            
            // Update styling to warning
            updateAlertLevelStyling(aiAlertCard, 'yellow');
        }
    }
    
    // Start AI analysis loading after page is ready
    console.log('‚è∞ DEBUG: Scheduling AI analysis to start in 1 second...');
    setTimeout(loadAIAnalysis, 1000); // Small delay to ensure page is fully rendered
});
</script>
{% endblock %}
